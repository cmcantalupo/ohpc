From ba57451d70903c66e8a5aec43212e908ff5f142e Mon Sep 17 00:00:00 2001
From: "Christopher M. Cantalupo" <christopher.m.cantalupo@intel.com>
Date: Mon, 30 Apr 2018 22:15:33 -0700
Subject: [PATCH] Make msr_batch_op struct wmask field an input parameter.

Signed-off-by: Christopher M. Cantalupo <christopher.m.cantalupo@intel.com>
---
 msr_batch.c | 8 +++-----
 msr_safe.h  | 2 +-
 2 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/msr_batch.c b/msr_batch.c
index 40254d8..0c385f3 100644
--- a/msr_batch.c
+++ b/msr_batch.c
@@ -121,11 +121,9 @@ static int msrbatch_apply_whitelist(struct msr_batch_array *oa)
         }
         else
         {
-            op->wmask = msr_whitelist_writemask(op->msr);
-            /* Check for read-only case */
-            if (op->wmask == 0 && !op->isrdmsr)
-            {
-                pr_debug("MSR %x is read-only\n", op->msr);
+            /* Check that provided write mask is subset of whitelist mask */
+            if (!op->isrdmsr && (op->mask & ~msr_whitelist_writemask(op->msr))) {
+                pr_debug("MSR %x write mask conflicts with whitelist\n", op->msr);
                 op->err = err = -EACCES;
             }
         }
diff --git a/msr_safe.h b/msr_safe.h
index 28fb01b..47463a6 100644
--- a/msr_safe.h
+++ b/msr_safe.h
@@ -50,7 +50,7 @@ struct msr_batch_op
     __s32 err;     // Out: set if error occurred with this operation
     __u32 msr;     // In: MSR Address to perform operation
     __u64 msrdata; // In/Out: Input/Result to/from operation
-    __u64 wmask;   // Out: Write mask applied to wrmsr
+    __u64 wmask;   // In: Write mask applied to wrmsr
 };
 
 struct msr_batch_array
-- 
1.8.3.1

